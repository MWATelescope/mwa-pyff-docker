- when update:
    - load:
        - aaf_prod.xrd
        - aaf_edugain.xrd
        - scg-idp-metadata.xml
        - mwa-federation-metadata.xml
        - unitedid-metadata.xml
    - select as /mwa_discovery: 
        - "https://md.aaf.edu.au/aaf-metadata.xml!//md:EntityDescriptor[@entityID='https://proxy.mwatelescope.org/sp']"
        - "https://md.aaf.edu.au/aaf-metadata.xml!//md:EntityDescriptor[md:IDPSSODescriptor]"
        - "https://md.aaf.edu.au/aaf-edugain-metadata.xml!//md:EntityDescriptor[md:IDPSSODescriptor and md:Extensions/mdrpi:RegistrationInfo/@registrationAuthority='https://incommon.org' and not(md:Extensions/mdattr:EntityAttributes/saml:Attribute/saml:AttributeValue = 'http://refeds.org/category/hide-from-discovery')]"
    - break
- when request:
    - select:
    - pipe:
        - when accept application/xml:
            - first
            - finalize:
                cacheDuration: PT12H
                validUntil: P10D
            - sign:
                key: metadata-signer.key
                cert: metadata-signer.crt
            - emit application/xml
            - break
        - when accept application/json:
            - xslt:
                stylesheet: discojson.xsl
            - emit application/json
            - break
